C51 COMPILER V9.54   IIC                                                                   11/29/2022 16:45:00 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Obj\iic.obj
COMPILER INVOKED BY: C:\dev\Keil5For51\C51\BIN\C51.EXE App\iic\iic.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Public;.\App\24c0
                    -2;.\App\iic;.\App\key;.\App\smg) DEBUG OBJECTEXTEND PRINT(.\Obj\iic.lst) TABS(2) OBJECT(.\Obj\iic.obj)

line level    source

   1          #include "iic.h"
   2          
   3          
   4          /*******************************************************************************
   5          * 函 数 名       : iic_start
   6          * 函数功能     : 产生IIC起始信号
   7          * 输    入       : 无
   8          * 输    出       : 无
   9          *******************************************************************************/
  10          void iic_start(void)
  11          {
  12   1        IIC_SDA=1;//如果把该条语句放在SCL后面，第二次读写会出现问题
  13   1        delay_10us(1);
  14   1        IIC_SCL=1;
  15   1        delay_10us(1);
  16   1        IIC_SDA=0;  //当SCL为高电平时，SDA由高变为低
  17   1        delay_10us(1);
  18   1        IIC_SCL=0;//钳住I2C总线，准备发送或接收数据
  19   1        delay_10us(1);
  20   1      }
  21          
  22          /*******************************************************************************
  23          * 函 数 名         : iic_stop
  24          * 函数功能       : 产生IIC停止信号   
  25          * 输    入         : 无
  26          * 输    出         : 无
  27          *******************************************************************************/
  28          void iic_stop(void)
  29          { 
  30   1        IIC_SDA=0;//如果把该条语句放在SCL后面，第二次读写会出现问题
  31   1        delay_10us(1);
  32   1        IIC_SCL=1;
  33   1        delay_10us(1);
  34   1        IIC_SDA=1;  //当SCL为高电平时，SDA由低变为高
  35   1        delay_10us(1);      
  36   1      }
  37          
  38          /*******************************************************************************
  39          * 函 数 名         : iic_ack
  40          * 函数功能       : 产生ACK应答  
  41          * 输    入         : 无
  42          * 输    出         : 无
  43          *******************************************************************************/
  44          void iic_ack(void)
  45          {
  46   1        IIC_SCL=0;
  47   1        IIC_SDA=0;  //SDA为低电平
  48   1        delay_10us(1);
  49   1          IIC_SCL=1;
  50   1        delay_10us(1);
  51   1        IIC_SCL=0;
  52   1      }
  53          
  54          /*******************************************************************************
C51 COMPILER V9.54   IIC                                                                   11/29/2022 16:45:00 PAGE 2   

  55          * 函 数 名         : iic_nack
  56          * 函数功能       : 产生NACK非应答  
  57          * 输    入         : 无
  58          * 输    出         : 无
  59          *******************************************************************************/
  60          void iic_nack(void)
  61          {
  62   1        IIC_SCL=0;
  63   1        IIC_SDA=1;  //SDA为高电平
  64   1        delay_10us(1);
  65   1          IIC_SCL=1;
  66   1        delay_10us(1);
  67   1        IIC_SCL=0;  
  68   1      }
  69          
  70          /*******************************************************************************
  71          * 函 数 名         : iic_wait_ack
  72          * 函数功能       : 等待应答信号到来   
  73          * 输    入         : 无
  74          * 输    出         : 1，接收应答失败
  75                         0，接收应答成功
  76          *******************************************************************************/
  77          u8 iic_wait_ack(void)
  78          {
  79   1        u8 time_temp=0;
  80   1        
  81   1        IIC_SCL=1;
  82   1        delay_10us(1);
  83   1        while(IIC_SDA)  //等待SDA为低电平
  84   1        {
  85   2          time_temp++;
  86   2          if(time_temp>100)//超时则强制结束IIC通信
  87   2          { 
  88   3            iic_stop();
  89   3            return 1; 
  90   3          }     
  91   2        }
  92   1        IIC_SCL=0;
  93   1        return 0; 
  94   1      }
  95          
  96          /*******************************************************************************
  97          * 函 数 名         : iic_write_byte
  98          * 函数功能       : IIC发送一个字节 
  99          * 输    入         : dat：发送一个字节
 100          * 输    出         : 无
 101          *******************************************************************************/
 102          void iic_write_byte(u8 dat)
 103          {                        
 104   1          u8 i=0; 
 105   1                
 106   1          IIC_SCL=0;
 107   1          for(i=0;i<8;i++)  //循环8次将一个字节传出，先传高再传低位
 108   1          {              
 109   2              if((dat&0x80)>0) 
 110   2            IIC_SDA=1;
 111   2          else
 112   2            IIC_SDA=0;
 113   2              dat<<=1;    
 114   2          delay_10us(1);  
 115   2          IIC_SCL=1;
 116   2          delay_10us(1); 
C51 COMPILER V9.54   IIC                                                                   11/29/2022 16:45:00 PAGE 3   

 117   2          IIC_SCL=0;  
 118   2          delay_10us(1);
 119   2          }  
 120   1      }
 121          
 122          /*******************************************************************************
 123          * 函 数 名         : iic_read_byte
 124          * 函数功能       : IIC读一个字节 
 125          * 输    入         : ack=1时，发送ACK，ack=0，发送nACK 
 126          * 输    出         : 应答或非应答
 127          *******************************************************************************/
 128          u8 iic_read_byte(u8 ack)
 129          {
 130   1        u8 i=0,receive=0;
 131   1          
 132   1          for(i=0;i<8;i++ ) //循环8次将一个字节读出，先读高再传低位
 133   1        {
 134   2              IIC_SCL=0; 
 135   2              delay_10us(1);
 136   2          IIC_SCL=1;
 137   2              receive<<=1;
 138   2              if(IIC_SDA)receive++;   
 139   2          delay_10us(1); 
 140   2          }          
 141   1          if (!ack)
 142   1              iic_nack();
 143   1          else
 144   1              iic_ack();  
 145   1            
 146   1          return receive;
 147   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    270    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
